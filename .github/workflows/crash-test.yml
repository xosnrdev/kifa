name: Crash Test (LazyFS)

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      cycles:
        description: "Number of crash cycles"
        required: false
        default: "50"
      flush_mode:
        description: "Flush mode to test"
        required: false
        default: "cautious"
        type: choice
        options:
          - normal
          - cautious
          - emergency

permissions:
  contents: read

env:
  DOCKER_BUILDKIT: 1
  CARGO_TERM_COLOR: always

jobs:
  crash-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        flush_mode:
          - cautious
          - normal
          - emergency
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build crash test Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.crash-test
          push: false
          load: true
          tags: kifa-crash-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run crash test (${{ matrix.flush_mode }} mode)
        run: |
          docker run \
            --cap-add SYS_ADMIN \
            --device /dev/fuse \
            --security-opt apparmor:unconfined \
            kifa-crash-test:latest \
            --cycles ${{ github.event.inputs.cycles || '50' }} \
            --flush-mode ${{ matrix.flush_mode }}

      - name: Upload crash test logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: crash-test-logs-${{ matrix.flush_mode }}
          path: |
            /tmp/lazyfs.log
          retention-days: 7

  crash-test-summary:
    runs-on: ubuntu-latest
    needs: crash-test
    if: always()
    steps:
      - name: Check crash test results
        run: |
          if [ "${{ needs.crash-test.result }}" = "success" ]; then
            echo -e "\033[32mAll crash tests passed!\033[0m"
          else
            echo -e "\033[31mSome crash tests failed\033[0m"
            exit 1
          fi
